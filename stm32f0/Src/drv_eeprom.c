/**
 ******************************************************************************
 * @file    drv_eeprom.c
 * @author  MEMS Application Team
 * @version V1.1
 * @date    10-August-2016
 * @brief   drv_eeprom source file
 ******************************************************************************
 */

/* Includes ------------------------------------------------------------------*/
#include "string.h"
#include "drv_eeprom.h"
#include "drv.h"

#define EDID_I2C_ADDR    0xA0
#define SEDID_SIZE       128
#define EEDID_SIZE       256

#define EEPROM_BYTES_PER_ROW  8

/* Private variables ---------------------------------------------------------*/
extern I2C_HandleTypeDef hi2c2;

static uint8_t IT6802_HDMI_EDID_TABLE[256] = {
#if 0  
  0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,// address 0x00
  0x11,0x90,0x50,0x50,0x01,0x00,0x00,0x00,//
  0x08,0x13,0x01,0x03,0x80,0x34,0x20,0xA0,// address 0x10
  0x2A,0xEE,0x95,0xA3,0x54,0x4C,0x99,0x26,//
  0x0F,0x50,0x54,0x21,0x08,0x00,0x01,0x01,// address 0x20
  0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,//
  0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x1D,// address 0x30
  0x00,0x72,0x51,0xD0,0x1E,0x20,0x6E,0x28,//
  0x55,0x00,0x00,0xD0,0x52,0x00,0x00,0x1E,// address 0x40
  0x8C,0x0A,0xD0,0x8A,0x20,0xE0,0x2D,0x10,//
  0x10,0x3E,0x96,0x00,0xD0,0xE0,0x21,0x00,// address 0x50
  0x00,0x1E,0x00,0x00,0x00,0xFC,0x00,0x49,//
  0x54,0x45,0x36,0x38,0x30,0x31,0x20,0x0A,// address 0x60
  0x20,0x20,0x20,0x20,0x00,0x00,0x00,0xFD,//
  0x00,0x30,0x7A,0x1F,0x41,0x0F,0x00,0x0A,// address 0x70
  0x20,0x20,0x20,0x20,0x20,0x20,0x01,0x44,//
  0x02,0x03,0x1B,0x41,0x83,0x01,0x00,0x00,// address 0x80
  0x65,0x03,0x0C,0x00,0x10,0x00,0x48,0x84,//
  0x02,0x03,0x11,0x12,0x13,0x2A,0x30,0x23,// address 0x90
  0x09,0x07,0x07,0x16,0x0D,0x60,0x6A,0x30,//
  0xE0,0x5F,0x10,0x04,0x28,0xFF,0x07,0x60,// address 0xA0
  0xE0,0x31,0x00,0x00,0x1E,0x44,0x0C,0x56,//
  0x36,0x30,0xE0,0x60,0x10,0xEA,0x28,0x0F,// address 0xB0
  0xC3,0x56,0xE0,0x31,0x00,0x00,0x1E,0x47,//
  0x09,0x80,0x30,0x20,0xE0,0x5F,0x10,0xE4,// address 0xC0
  0x28,0xFF,0xCF,0x80,0xE0,0x21,0x00,0x00,//
  0x3E,0x9E,0x20,0x00,0x90,0x51,0x20,0x1F,// address 0xD0
  0x30,0x48,0x80,0x36,0x00,0x00,0x20,0x53,//
  0x00,0x00,0x1A,0x00,0x00,0x00,0x00,0x00,// address 0xE0
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// address 0xF0
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x69,//
#else
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// address 0x00
  0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,//
  0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,// address 0x10
  0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,//
  0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,// address 0x20
  0x0A,0x0A,0x0A,0x0A,0x0A,0x0A,0x0A,0x0A,//
  0x0B,0x0B,0x0B,0x0B,0x0B,0x0B,0x0B,0x0B,// address 0x30
  0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,//
  0x0D,0x0D,0x0D,0x0D,0x0D,0x0D,0x0D,0x0D,// address 0x40
  0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,//
  0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,// address 0x50
  0x00,0x1E,0x00,0x00,0x00,0xFC,0x00,0x49,//
  0x54,0x45,0x36,0x38,0x30,0x31,0x20,0x0A,// address 0x60
  0x20,0x20,0x20,0x20,0x00,0x00,0x00,0xFD,//
  0x00,0x30,0x7A,0x1F,0x41,0x0F,0x00,0x0A,// address 0x70
  0x20,0x20,0x20,0x20,0x20,0x20,0x01,0x44,//
  0x02,0x03,0x1B,0x41,0x83,0x01,0x00,0x00,// address 0x80
  0x65,0x03,0x0C,0x00,0x10,0x00,0x48,0x84,//
  0x02,0x03,0x11,0x12,0x13,0x2A,0x30,0x23,// address 0x90
  0x09,0x07,0x07,0x16,0x0D,0x60,0x6A,0x30,//
  0xE0,0x5F,0x10,0x04,0x28,0xFF,0x07,0x60,// address 0xA0
  0xE0,0x31,0x00,0x00,0x1E,0x44,0x0C,0x56,//
  0x36,0x30,0xE0,0x60,0x10,0xEA,0x28,0x0F,// address 0xB0
  0xC3,0x56,0xE0,0x31,0x00,0x00,0x1E,0x47,//
  0x09,0x80,0x30,0x20,0xE0,0x5F,0x10,0xE4,// address 0xC0
  0x28,0xFF,0xCF,0x80,0xE0,0x21,0x00,0x00,//
  0x3E,0x9E,0x20,0x00,0x90,0x51,0x20,0x1F,// address 0xD0
  0x30,0x48,0x80,0x36,0x00,0x00,0x20,0x53,//
  0x00,0x00,0x1A,0x00,0x00,0x00,0x00,0x00,// address 0xE0
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// address 0xF0
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x69,//
#endif
};

/* Private function prototypes -----------------------------------------------*/

/**
  * @brief  The drv_eeprom init.
  */
void Drv_EEPROM_Init(void)
{

}

void Drv_EEPROM_Proc(void)
{

}

uint8_t drv_eeprom_read_edid(void)
{
  uint8_t row[EEPROM_BYTES_PER_ROW], pages;
  uint8_t i,ret,offset;

  pages = (sizeof(IT6802_HDMI_EDID_TABLE)>SEDID_SIZE?EEDID_SIZE:SEDID_SIZE)/EEPROM_BYTES_PER_ROW;
  for (i=0,offset=0;i<pages;i++,offset+=EEPROM_BYTES_PER_ROW)
  {
    ret = HAL_I2C_Mem_Read(&hi2c2, EDID_I2C_ADDR, offset, 1, row, EEPROM_BYTES_PER_ROW, 1000);
    if (ret == HAL_OK)
    {
      Drv_SERIAL_Log("row 0x%02X: 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X 0x%02X", 
                      i*EEPROM_BYTES_PER_ROW,
                      row[0],row[1],row[2],row[3],row[4],row[5],row[6],row[7]);
    }
    else
    {
      Drv_SERIAL_Log("EDID Read error in row 0x%02X", i*EEPROM_BYTES_PER_ROW);
      break;
    }
  }
  
  return ret;
}

uint8_t drv_eeprom_write_edid(void)
{
  uint8_t row[EEPROM_BYTES_PER_ROW], pages;
  uint8_t i,ret,offset;
  
  pages = (sizeof(IT6802_HDMI_EDID_TABLE)>SEDID_SIZE?EEDID_SIZE:SEDID_SIZE)/EEPROM_BYTES_PER_ROW;
  for (i=0,offset=0;i<pages;i++,offset+=EEPROM_BYTES_PER_ROW)
  {
    ret = HAL_I2C_Mem_Write(&hi2c2, EDID_I2C_ADDR, 
                            offset, 1, &IT6802_HDMI_EDID_TABLE[offset], 
                            EEPROM_BYTES_PER_ROW, 1000);
    if (HAL_OK==ret)
    {
      ret = HAL_I2C_Mem_Read(&hi2c2, EDID_I2C_ADDR, 
                             offset, 1, row, 
                             EEPROM_BYTES_PER_ROW, 1000);
      if (HAL_OK==ret)
      {
        if (memcmp(row, &IT6802_HDMI_EDID_TABLE[offset], EEPROM_BYTES_PER_ROW))
        {
          Drv_SERIAL_Log("EDID Write check error in row 0x%02X", offset);          
          return HAL_ERROR;
        }
      }
      else
      {
        Drv_SERIAL_Log("EDID Write read error in row 0x%02X", offset);
        return HAL_ERROR;
      }
    }
    else
    {
      Drv_SERIAL_Log("EDID Write write error in row 0x%02X", offset);
      return HAL_ERROR;
    }
  }

  Drv_SERIAL_Log("EDID Write successful!");
  return HAL_OK;
}

